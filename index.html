<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Asistente de Viaje v1.0.44</title>
    <meta name="description" content="Bitácora de viajes y gastos offline">
    <meta name="theme-color" content="#0f172a">
    <link rel="manifest" href="./manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; user-select: none; touch-action: manipulation; overscroll-behavior-y: none; background-color: #f1f5f9; }
        input, textarea, select { user-select: text; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        /* Estilos para pantalla de error */
        #error-display { display: none; padding: 20px; background: #fee2e2; color: #991b1b; border: 2px solid #b91c1c; margin: 20px; border-radius: 10px; font-family: monospace; white-space: pre-wrap; z-index: 9999; position: relative; }
    </style>

    <script>
        // Si hay un SW viejo molestando, esto lo elimina para forzar la actualización
        if (window.navigator && navigator.serviceWorker) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    // Solo desregistramos si no es el controlador actual para evitar loops
                    // registration.unregister(); 
                }
            });
        }
        
        // Manejador global de errores para mostrar en pantalla en lugar de pantalla blanca
        window.onerror = function(message, source, lineno, colno, error) {
            const display = document.getElementById('error-display');
            if (display) {
                display.style.display = 'block';
                display.innerHTML = `<strong>⚠️ ERROR CRÍTICO:</strong>\n${message}\n\nEn: ${source}:${lineno}`;
            }
        };
    </script>
</head>
<body>
    <div id="error-display"></div>
    <div id="root"></div>

    <script>
        const APP_CONFIG = {
            VERSION: "1.0.44",
            REPO_URL: "https://github.com/fernandomontesdeoca-beep/gemini_asistente_de_viaje",
            // IMPORTANTE: Asegúrate de que version.json existe o esto dará error 404 (pero no romperá la app)
            VERSION_CHECK_URL: "https://raw.githubusercontent.com/fernandomontesdeoca-beep/gemini_asistente_de_viaje/main/version.json"
        };

        const OFFICIAL_RATES = { toll: '162.00', fuel: '78.02', electricAC: '9.50', electricDC: '10.80' };

        // Fallback seguro para generación de IDs
        const generateId = () => {
            if (self.crypto && self.crypto.randomUUID) return self.crypto.randomUUID();
            return `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        };
        
        const formatMoney = (amount) => Number(amount || 0).toFixed(2);
        
        const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            return `${mins}:${secs}`;
        };

        // --- CAPA DE DATOS (IndexedDB) ---
        const DB_NAME = 'TripAssistantDB';
        const STORE_NAME = 'app_data';
        const dbHelper = {
            init: () => new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, 2);
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME);
                };
                req.onsuccess = (e) => resolve(e.target.result);
                req.onerror = (e) => reject(e.target.error);
            }),
            get: async (key) => {
                try {
                    const db = await dbHelper.init();
                    return new Promise((resolve) => {
                        const req = db.transaction([STORE_NAME], 'readonly').objectStore(STORE_NAME).get(key);
                        req.onsuccess = () => resolve(req.result);
                        req.onerror = () => resolve(null);
                    });
                } catch(e) { console.error(e); return null; }
            },
            set: async (key, val) => {
                try {
                    const db = await dbHelper.init();
                    return new Promise((resolve, reject) => {
                        const req = db.transaction([STORE_NAME], 'readwrite').objectStore(STORE_NAME).put(val, key);
                        req.onsuccess = () => resolve();
                        req.onerror = (e) => reject(e.target.error);
                    });
                } catch(e) { console.error(e); }
            }
        };
        
        // REGISTRO SERVICE WORKER
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('SW registrado'))
                    .catch(err => console.log('SW falló:', err));
            });
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        // --- SISTEMA DE ICONOS (CORREGIDO) ---
        // Corrección: Info y Github ahora tienen <></>
        const ICONS = {
            Play: <polygon points="5 3 19 12 5 21 5 3" />,
            MapPin: <><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z" /><circle cx="12" cy="10" r="3" /></>,
            DollarSign: <><line x1="12" x2="12" y1="2" y2="22" /><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" /></>,
            Clock: <><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></>,
            Car: <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2" />,
            AlertTriangle: <><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><line x1="12" x2="12" y1="9" y2="13" /><line x1="12" x2="12.01" y1="17" y2="17" /></>,
            CheckCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></>,
            Plus: <><line x1="12" x2="12" y1="5" y2="19" /><line x1="5" x2="19" y1="12" y2="12" /></>,
            Settings: <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />,
            Fuel: <><line x1="3" x2="15" y1="22" y2="22" /><line x1="4" x2="14" y1="9" y2="9" /><path d="M14 22V4a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v18" /><path d="M14 13h2a2 2 0 0 1 2 2v2a2 2 0 0 0 2 2h0a2 2 0 0 0 2-2V9.83a2 2 0 0 0-.59-1.42L18 5" /></>,
            Utensils: <><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2" /><path d="M7 2v20" /><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7" /></>,
            Bed: <><path d="M2 4v16" /><path d="M2 8h18a2 2 0 0 1 2 2v10" /><path d="M2 17h20" /><path d="M6 8v9" /></>,
            Briefcase: <><rect width="20" height="14" x="2" y="7" rx="2" ry="2" /><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" /></>,
            CreditCard: <><rect width="20" height="14" x="2" y="5" rx="2" /><line x1="2" x2="22" y1="10" y2="10" /></>,
            Wallet: <path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4" />,
            Landmark: <><line x1="3" x2="21" y1="22" y2="22" /><line x1="6" x2="6" y1="18" y2="11" /><line x1="10" x2="10" y1="18" y2="11" /><line x1="14" x2="14" y1="18" y2="11" /><line x1="18" x2="18" y1="18" y2="11" /><polygon points="12 2 20 7 4 7" /></>,
            X: <><path d="M18 6 6 18" /><path d="m6 6 12 12" /></>,
            Zap: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />,
            Truck: <><rect width="16" height="13" x="1" y="6" rx="2" /><polygon points="17 10 22 11 22 17 17 17 17 10" /></>,
            Edit2: <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />,
            ChevronDown: <path d="m6 9 6 6 6-6" />,
            ShoppingBag: <><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z" /><path d="M3 6h18" /><path d="M16 10a4 4 0 0 1-8 0" /></>,
            History: <><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12" /><path d="M3 3v9h9" /><path d="M12 7v5l4 2" /></>,
            User: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></>,
            Users: <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></>,
            StickyNote: <><path d="M15.5 3H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2V8.5L15.5 3Z" /><path d="M15 3v6h6" /></>,
            ArrowRight: <path d="M5 12h14M12 5l7 7-7 7" />,
            Trash2: <><path d="M3 6h18" /><path d="M19 6v14c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2V6" /><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></>,
            Calendar: <><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /></>,
            Home: <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />,
            // AQUÍ ESTÁ LA CORRECCIÓN: Se agregaron los fragments <></>
            Info: <><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="16" y2="12" /><line x1="12" x2="12.01" y1="8" y2="8" /></>,
            Github: <><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4" /><path d="M9 18c-4.51 2-5-2-7-2" /></>,
        };
        const Icon = ({ name, size = 24, className = "" }) => ICONS[name] ? <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{ICONS[name]}</svg> : null;

        // --- COMPONENTES UI ATÓMICOS ---
        const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false }) => {
            const baseStyle = "py-3 rounded-xl font-bold transition-all active:scale-95 disabled:opacity-50 disabled:scale-100";
            const variants = {
                primary: "bg-blue-600 text-white shadow-lg hover:bg-blue-700",
                secondary: "bg-slate-100 text-slate-500 hover:bg-slate-200",
                danger: "bg-rose-50 text-rose-600 hover:bg-rose-100",
                success: "bg-emerald-600 text-white shadow-lg hover:bg-emerald-700",
                ghost: "bg-transparent text-slate-400 hover:text-slate-600"
            };
            return <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`}>{children}</button>;
        };

        const Card = ({ children, className = "", onClick }) => (
            <div onClick={onClick} className={`bg-white rounded-2xl shadow-sm border border-slate-100 p-4 ${className} ${onClick ? 'cursor-pointer active:scale-95 transition-transform' : ''}`}>{children}</div>
        );

        // --- CUSTOM HOOKS ---

        // Hook de Versión de GitHub (A PRUEBA DE FALLOS)
        const useGitHubVersion = () => {
            const [newVersion, setNewVersion] = useState(null);
            useEffect(() => {
                fetch(APP_CONFIG.VERSION_CHECK_URL)
                    .then(res => {
                        if (!res.ok) throw new Error("404 Not Found");
                        return res.json();
                    })
                    .then(data => {
                        const currentParts = APP_CONFIG.VERSION.split('.').map(Number);
                        const remoteParts = data.version.split('.').map(Number);
                        let hasUpdate = false;
                        for(let i=0; i<3; i++) {
                            if (remoteParts[i] > currentParts[i]) { hasUpdate = true; break; }
                            if (remoteParts[i] < currentParts[i]) break;
                        }
                        if (hasUpdate) setNewVersion(data.version);
                    })
                    .catch(e => {
                        console.log("No se pudo verificar actualizaciones (posiblemente offline o falta version.json)", e);
                    });
            }, []);
            return newVersion;
        };

        // Hook Genérico de Persistencia IndexedDB
        const useIndexedDB = (key, initialValue) => {
            const [state, setState] = useState(initialValue);
            const [loaded, setLoaded] = useState(false);

            useEffect(() => {
                dbHelper.get(key).then(data => {
                    if (data !== null && data !== undefined) setState(data);
                    setLoaded(true);
                });
            }, [key]);

            const setPersistedState = (newValue) => {
                setState(newValue);
                dbHelper.set(key, newValue); 
            };
            return [state, setPersistedState, loaded];
        };

        // --- COMPONENTE PRINCIPAL ---
        const App = () => {
            // Estados Persistentes (siempre en IndexedDB)
            const [trips, setTrips, tripsLoaded] = useIndexedDB('trips', []);
            const [expenses, setExpenses, expLoaded] = useIndexedDB('expenses', []);
            const [visits, setVisits, visitsLoaded] = useIndexedDB('visits', []);
            const [odometers, setOdometers, odoLoaded] = useIndexedDB('odometers', { PERSONAL: 0, COMPANY_FUEL: 0, COMPANY_ELECTRIC: 0, OTHER: 0 });
            const [configs, setConfigs, confLoaded] = useIndexedDB('configs', {
                PERSONAL: { tollPrice: OFFICIAL_RATES.toll, fuelPrice: OFFICIAL_RATES.fuel, kmValue: '15.00', currency: 'UYU' },
                COMPANY_FUEL: { tollPrice: OFFICIAL_RATES.toll, fuelPrice: OFFICIAL_RATES.fuel, kmValue: '12.00', currency: 'UYU' },
                COMPANY_ELECTRIC: { tollPrice: OFFICIAL_RATES.toll, fuelPriceAC: OFFICIAL_RATES.electricAC, fuelPriceDC: OFFICIAL_RATES.electricDC, kmValue: '4.00', currency: 'UYU' }, 
                OTHER: { tollPrice: OFFICIAL_RATES.toll, fuelPrice: OFFICIAL_RATES.fuel, kmValue: '20.00', currency: 'UYU' }
            });
            const [lastLocation, setLastLocation, locLoaded] = useIndexedDB('lastLocation', 'Casa');
            
            // Estado de Sesión
            const [appState, setAppState] = useState('IDLE');
            const [currentTrip, setCurrentTrip] = useState(null);
            
            // UI States
            const [dashboardVehicleId, setDashboardVehicleId] = useState('PERSONAL');
            const [modals, setModals] = useState({ 
                vehicleSelector: false, locationSelector: false, expense: false, 
                history: false, settings: false, resume: false, info: false, newVersion: false 
            });
            const [expenseModalData, setExpenseModalData] = useState(null);
            const [elapsedTime, setElapsedTime] = useState(0);

            // Hook de Version
            const remoteVersion = useGitHubVersion();

            // Carga inicial de sesión interrumpida
            useEffect(() => {
                Promise.all([dbHelper.get('appState'), dbHelper.get('currentTrip')]).then(([savedState, savedTrip]) => {
                    if (savedState === 'ACTIVE' && savedTrip) {
                        setCurrentTrip({ ...savedTrip, startTime: new Date(savedTrip.startTime) });
                        setModals(prev => ({ ...prev, resume: true }));
                    }
                });
            }, []);

            // Efecto de Version
            useEffect(() => {
                if (remoteVersion) setModals(prev => ({ ...prev, newVersion: true }));
            }, [remoteVersion]);

            // Timer del Viaje
            useEffect(() => {
                let interval;
                if (appState === 'ACTIVE' && currentTrip?.startTime) {
                    const start = new Date(currentTrip.startTime).getTime();
                    interval = setInterval(() => {
                        setElapsedTime(Math.floor((Date.now() - start) / 1000));
                    }, 1000);
                } else {
                    setElapsedTime(0);
                }
                return () => clearInterval(interval);
            }, [appState, currentTrip]);

            // Persistencia Crítica de Estado
            useEffect(() => {
                if (tripsLoaded) {
                   dbHelper.set('appState', appState);
                   dbHelper.set('currentTrip', currentTrip);
                }
            }, [appState, currentTrip, tripsLoaded]);


            // --- ACTIONS ---
            const handleStartTrip = (odo, dest) => {
                const newTrip = {
                    id: generateId(),
                    startTime: new Date(),
                    vehicle: dashboardVehicleId,
                    origin: lastLocation,
                    destination: dest || '',
                    startOdometer: parseInt(odo),
                    tripExpenses: []
                };
                setCurrentTrip(newTrip);
                setAppState('ACTIVE');
            };

            const handleEndTrip = (endOdo, dest) => {
                const distance = parseInt(endOdo) - currentTrip.startOdometer;
                const finalTrip = {
                    ...currentTrip,
                    endTime: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    startTime: currentTrip.startTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    date: new Date().toLocaleDateString(),
                    destination: dest,
                    distance: distance > 0 ? distance : 0,
                    endOdometer: parseInt(endOdo),
                    expenses: currentTrip.tripExpenses
                };
                
                setTrips([finalTrip, ...trips]);
                setOdometers({...odometers, [currentTrip.vehicle]: parseInt(endOdo)});
                setLastLocation(dest);
                
                setAppState('IDLE');
                setCurrentTrip(null);
            };

            // --- VISTAS ---
            if (!tripsLoaded || !odoLoaded) return <div className="flex h-screen items-center justify-center text-slate-400">Cargando...</div>;

            return (
                <div className="flex flex-col h-screen w-full max-w-md mx-auto shadow-2xl relative bg-slate-100 overflow-hidden font-sans">
                    
                    {/* MODALES GLOBALES */}
                    {modals.resume && (
                        <div className="absolute inset-0 bg-black/80 z-[100] flex items-center justify-center p-6 animate-fade-in">
                            <div className="bg-white rounded-3xl p-6 w-full max-w-sm border-l-4 border-amber-500">
                                <h3 className="text-xl font-bold text-slate-800 mb-2">⚠️ Viaje Interrumpido</h3>
                                <p className="text-slate-600 mb-6 text-sm">Se detectó un cierre inesperado. ¿Continuar viaje desde {currentTrip?.origin}?</p>
                                <div className="flex gap-3">
                                    <Button variant="danger" className="flex-1" onClick={() => { setCurrentTrip(null); setAppState('IDLE'); setModals(m=>({...m, resume:false})); }}>Descartar</Button>
                                    <Button className="flex-1" onClick={() => { setAppState('ACTIVE'); setModals(m=>({...m, resume:false})); }}>Continuar</Button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {modals.newVersion && (
                        <div className="absolute inset-0 bg-black/70 z-[100] flex items-center justify-center p-6">
                            <div className="bg-white rounded-3xl p-6 w-full max-w-sm text-center">
                                <div className="bg-emerald-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4"><Icon name="Zap" className="text-emerald-600"/></div>
                                <h3 className="text-xl font-bold mb-2">Nueva Versión {remoteVersion}</h3>
                                <div className="flex gap-3 mt-6">
                                    <Button variant="secondary" className="flex-1" onClick={() => setModals(m=>({...m, newVersion:false}))}>Luego</Button>
                                    <Button className="flex-1" onClick={() => window.location.href = APP_CONFIG.REPO_URL}>Actualizar</Button>
                                </div>
                            </div>
                        </div>
                    )}

                    {modals.info && (
                        <div className="absolute inset-0 bg-black/60 z-[90] flex items-center justify-center p-6" onClick={() => setModals(m=>({...m, info:false}))}>
                            <Card className="w-full max-w-sm" onClick={(e) => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-lg flex items-center"><Icon name="Info" className="mr-2 text-blue-600"/> Acerca de</h3>
                                    <button onClick={() => setModals(m=>({...m, info:false}))}><Icon name="X" className="text-slate-400"/></button>
                                </div>
                                <div className="space-y-3 text-sm">
                                    <div className="bg-slate-50 p-3 rounded-xl border border-slate-100">
                                        <div className="font-bold text-slate-500 text-xs uppercase">Versión Actual</div>
                                        <div className="text-xl font-bold text-slate-800">{APP_CONFIG.VERSION}</div>
                                    </div>
                                    <div className="bg-slate-50 p-3 rounded-xl border border-slate-100">
                                        <div className="font-bold text-slate-500 text-xs uppercase">Estado Datos</div>
                                        <div className="text-emerald-600 font-bold flex items-center"><Icon name="CheckCircle" size={14} className="mr-1"/> Guardado en IndexedDB</div>
                                    </div>
                                    <Button variant="secondary" className="w-full mt-2" onClick={() => window.open(APP_CONFIG.REPO_URL, '_blank')}>
                                        <span className="flex items-center justify-center"><Icon name="Github" size={16} className="mr-2"/> Ver Código Fuente</span>
                                    </Button>
                                </div>
                            </Card>
                        </div>
                    )}

                    {/* VISTA: IDLE (Home) */}
                    {appState === 'IDLE' && (
                        <div className="flex flex-col h-full">
                            <div className="bg-slate-800 text-white p-6 rounded-b-[2.5rem] shadow-xl z-10 relative">
                                <button onClick={() => setModals(m=>({...m, info:true}))} className="absolute top-6 left-6 text-slate-400 hover:text-white"><Icon name="Info" size={20}/></button>
                                <div className="flex justify-end mb-6 gap-2">
                                    <button className="p-2 bg-slate-700 rounded-full"><Icon name="History" size={20}/></button>
                                    <button className="p-2 bg-slate-700 rounded-full"><Icon name="Settings" size={20}/></button>
                                </div>
                                <div className="text-center mb-6">
                                    <h1 className="text-2xl font-bold">Bitácora de Viaje</h1>
                                    <p className="text-slate-400 text-xs">Sistema Offline v{APP_CONFIG.VERSION}</p>
                                </div>
                                {/* Tarjeta Vehículo */}
                                <Card className="bg-slate-700/50 border-slate-600 backdrop-blur-md text-white mb-2">
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <div className="text-xs text-slate-400 font-bold uppercase">Vehículo Actual</div>
                                            <div className="text-lg font-bold flex items-center mt-1">
                                                <Icon name="Car" className="mr-2 text-blue-400"/> Personal
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <div className="font-mono text-2xl font-bold">{odometers['PERSONAL']}</div>
                                            <div className="text-[10px] text-slate-400">KILÓMETROS</div>
                                        </div>
                                    </div>
                                </Card>
                            </div>

                            <div className="flex-1 flex flex-col items-center justify-center p-6 gap-6 relative">
                                <div className="absolute top-0 w-full px-10 flex justify-between -mt-6 z-20">
                                    <button className="bg-white p-4 rounded-2xl shadow-lg text-orange-600 flex flex-col items-center w-24 active:scale-95 transition-transform"><Icon name="Fuel" size={24} className="mb-1"/><span className="text-[10px] font-bold">CARGAR</span></button>
                                    <button className="bg-white p-4 rounded-2xl shadow-lg text-blue-600 flex flex-col items-center w-24 active:scale-95 transition-transform"><Icon name="Car" size={24} className="mb-1"/><span className="text-[10px] font-bold">PARKING</span></button>
                                </div>

                                <button onClick={() => handleStartTrip(odometers['PERSONAL'])} className="w-56 h-56 rounded-full bg-gradient-to-b from-emerald-500 to-emerald-600 shadow-2xl shadow-emerald-200/50 flex flex-col items-center justify-center border-8 border-white active:scale-95 transition-all z-10 mt-10 group">
                                    <Icon name="Play" size={64} className="text-white ml-2 group-hover:scale-110 transition-transform"/>
                                    <span className="text-white font-bold text-xl tracking-widest mt-2">INICIAR</span>
                                </button>
                            </div>
                        </div>
                    )}

                    {/* VISTA: ACTIVE */}
                    {appState === 'ACTIVE' && (
                        <div className="flex flex-col h-full bg-slate-900 text-white">
                            <div className="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-900 z-10">
                                <div className="flex items-center text-emerald-400 animate-pulse">
                                    <div className="w-2 h-2 bg-emerald-400 rounded-full mr-2"></div>
                                    <span className="font-bold text-xs tracking-widest uppercase">En Ruta</span>
                                </div>
                                <div className="font-mono text-xl flex items-center">
                                    <Icon name="Clock" size={16} className="mr-2 text-slate-500"/>
                                    {formatTime(elapsedTime)}
                                </div>
                            </div>
                            <div className="flex-1 flex flex-col justify-center items-center p-6">
                                <div className="text-center mb-10">
                                    <div className="text-slate-500 text-xs font-bold uppercase mb-2">Origen</div>
                                    <div className="text-4xl font-bold">{currentTrip.origin}</div>
                                </div>
                                <div className="grid grid-cols-2 gap-4 w-full">
                                    <Card className="bg-slate-800 border-slate-700 flex flex-col items-center py-6 active:bg-slate-700" onClick={()=>{/* Logica Gasto */}}>
                                        <Icon name="DollarSign" size={32} className="text-rose-400 mb-2"/>
                                        <span className="font-bold">PEAJE</span>
                                    </Card>
                                    <Card className="bg-slate-800 border-slate-700 flex flex-col items-center py-6 active:bg-slate-700">
                                        <Icon name="Plus" size={32} className="text-violet-400 mb-2"/>
                                        <span className="font-bold">OTRO</span>
                                    </Card>
                                </div>
                            </div>
                            <div className="p-6 bg-slate-900 border-t border-slate-800">
                                <Button variant="success" className="w-full py-4 text-lg" onClick={() => handleEndTrip(currentTrip.startOdometer + 10, 'Destino Simulado')}>
                                    <span className="flex items-center justify-center"><Icon name="MapPin" className="mr-2"/> LLEGAR A DESTINO</span>
                                </Button>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
